
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025 Memory Capsule</title>
  <base href="/">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- Shim for Import Maps (using cdnjs for better availability) -->
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/es-module-shims/1.10.0/es-module-shims.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500&family=Great+Vibes&display=swap" rel="stylesheet">
  
  <script>
    window.process = window.process || {};
    window.process.env = window.process.env || {};
    window.process.env.API_KEY = window.process.env.API_KEY || ''; 
  </script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            morandi: {
              bg: '#F2F0E9', card: '#FFFFFF', text: '#4A4A4A', accent: '#8E9AAF',
              sage: '#A6B08E', dusty: '#D6A692', sand: '#E3DCD2', dark: '#2C3E50', red: '#B94E48'
            }
          },
          fontFamily: {
            serif: ['Lora', 'serif'], sans: ['Inter', 'sans-serif'], display: ['Cinzel', 'serif'],
            art: ['Ma Shan Zheng', 'cursive'], cursive: ['Great Vibes', 'cursive'] 
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #F2F0E9; color: #4A4A4A; margin: 0; overflow-x: hidden; }
    .app-loading { height: 100vh; width: 100vw; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Lora', serif; color: #8E9AAF; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(142, 154, 175, 0.2); border-radius: 50%; border-top-color: #8E9AAF; animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Error Console */
    .load-error { display: none; margin-top: 20px; max-width: 90%; background: rgba(255,255,255,0.95); padding: 24px; border-radius: 8px; border: 1px solid #B94E48; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 9999; color: #333; }
    .error-title { color: #B94E48; font-weight: bold; font-size: 14px; margin-bottom: 8px; }
    .error-detail { font-family: monospace; font-size: 11px; background: #f0f0f0; padding: 10px; margin-top: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; max-height: 150px; text-align: left; }
    .retry-btn { margin-top: 15px; padding: 8px 20px; background-color: #8E9AAF; color: white; border-radius: 4px; font-size: 12px; cursor: pointer; border: none; }
    
    /* Styles from previous steps... */
    .capsule-bg { position: absolute; border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.4); overflow: hidden; }
    .capsule-liquid { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 140%; height: 140%; background: radial-gradient(circle at center, var(--liquid-color), transparent 60%); opacity: 0.5; filter: blur(50px); animation: liquid-move 8s infinite alternate; }
    @keyframes liquid-move { 0% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-45%, -55%) scale(1.1); } }
    .paper-texture { background-color: #F9F7F2; position: relative; }
    .paper-texture::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 0; opacity: 0.08; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
    .fade-in { animation: fadeIn 1s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .shake-gentle { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-2px, 0, 0); } 40%, 60% { transform: translate3d(2px, 0, 0); } }
    .capsule-open-top { animation: slideUp 0.8s ease-out forwards; }
    .capsule-open-bottom { animation: slideDown 0.8s ease-out forwards; }
    @keyframes slideUp { to { transform: translateY(-100%) scale(0.9); opacity: 0; } }
    @keyframes slideDown { to { transform: translateY(100%) scale(0.9); opacity: 0; } }
    .particle-drop { animation: dropBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards; }
    @keyframes dropBounce { 0% { transform: translateY(-50px) scale(0.5); opacity: 0; } 60% { transform: translateY(5px) scale(1.05); opacity: 1; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
    .particle-float { animation: floatDown 2s ease-out backwards; }
    @keyframes floatDown { 0% { transform: translateY(-30px) rotate(-20deg); opacity: 0; } 100% { transform: translateY(0) rotate(0deg); opacity: 0.8; } }
  </style>

<script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@7.8.1?target=es2022",
    "rxjs/operators": "https://esm.sh/rxjs@7.8.1/operators?target=es2022",
    "tslib": "https://esm.sh/tslib@2.6.2?target=es2022",
    "zone.js": "https://esm.sh/zone.js@0.15.0?target=es2022",
    "@google/genai": "https://esm.sh/@google/genai@0.2.0?target=es2022",
    "@angular/compiler": "https://esm.sh/@angular/compiler@19.1.0?target=es2022&external=rxjs,tslib,zone.js",
    "@angular/common": "https://esm.sh/@angular/common@19.1.0?target=es2022&external=rxjs,tslib,zone.js",
    "@angular/platform-browser": "https://esm.sh/@angular/platform-browser@19.1.0?target=es2022&external=rxjs,tslib,zone.js",
    "@angular/forms": "https://esm.sh/@angular/forms@19.1.0?target=es2022&external=rxjs,tslib,zone.js",
    "@angular/core": "https://esm.sh/@angular/core@19.1.0?target=es2022&external=rxjs,tslib,zone.js",
    "vite": "https://esm.sh/vite@^7.3.0?external=rxjs"
  }
}
</script>
</head>
<body>
  <app-root>
    <div class="app-loading" id="loading-container">
      <div class="loading-spinner"></div>
      <p>正在连接记忆库...</p>
      <p style="font-size: 10px; opacity: 0.5; margin-top: 5px;">Connecting to Memory Database...</p>
      
      <!-- Network Status Indicator -->
      <div id="network-status" style="margin-top: 10px; font-size: 9px; opacity: 0.6; font-family: monospace;">
        Checking CDN connectivity...
      </div>

      <div class="load-error" id="load-error-msg">
        <div class="error-title">启动失败 (Startup Failed)</div>
        <p class="text-xs text-morandi-text">
           这通常是网络问题导致的资源加载失败。
        </p>
        <ul class="text-[11px] text-left list-disc pl-4 text-morandi-text/80 mb-3 space-y-1 mt-2">
           <li>请检查是否开启了 <strong>VPN/代理</strong> (Google API & CDN 需要)。</li>
           <li>请尝试<strong>刷新页面</strong>。</li>
           <li>Detailed error below:</li>
        </ul>
        <div class="error-detail" id="error-text">No details yet.</div>
        <button class="retry-btn" onclick="window.location.reload()">刷新重试 (Reload)</button>
      </div>
    </div>
  </app-root>

  <script>
    // 1. Connectivity Check
    const statusEl = document.getElementById('network-status');
    const img = new Image();
    img.onload = () => { if(statusEl) statusEl.textContent = 'CDN (esm.sh) is reachable.'; statusEl.style.color = 'green'; };
    img.onerror = () => { if(statusEl) statusEl.textContent = 'Warning: CDN (esm.sh) might be blocked.'; statusEl.style.color = '#B94E48'; };
    img.src = 'https://esm.sh/favicon.ico?' + Date.now(); // Pixel check

    // 2. Global Error Capture (Including Syntax/Network errors)
    window.addEventListener('error', function(event) {
      const errorMsg = document.getElementById('load-error-msg');
      const errorText = document.getElementById('error-text');
      const loader = document.querySelector('.loading-spinner');
      const statusEl = document.getElementById('network-status');
      
      if (errorMsg && errorText) {
         errorMsg.style.display = 'block';
         if(loader) loader.style.display = 'none';
         if(statusEl) statusEl.style.display = 'none';

         let message = event.message || 'Unknown Error';
         if (event.filename) {
            message += `\nFile: ${event.filename}`;
         }
         if (event.lineno) {
            message += `\nLine: ${event.lineno}`;
         }
         // If it's a script loading error
         if (event.target && (event.target.tagName === 'SCRIPT' || event.target.tagName === 'LINK')) {
            message = `Resource Failed to Load: ${event.target.src || event.target.href}`;
         }

         errorText.textContent = message;
      }
    }, true); // Capture phase is essential for resource loading errors

    // 3. Unhandled Promise Rejection
    window.addEventListener('unhandledrejection', function(event) {
      const errorMsg = document.getElementById('load-error-msg');
      const errorText = document.getElementById('error-text');
      const loader = document.querySelector('.loading-spinner');
      
      if (errorMsg && errorText) {
         errorMsg.style.display = 'block';
         if(loader) loader.style.display = 'none';
         errorText.textContent = `Promise Rejection: ${event.reason}`;
      }
    });

    // 4. Manual Timeout Fallback
    setTimeout(() => {
      const appRoot = document.querySelector('app-root');
      const errorMsg = document.getElementById('load-error-msg');
      const errorText = document.getElementById('error-text');
      const loader = document.querySelector('.loading-spinner');
      
      if (appRoot && appRoot.children.length > 0 && errorMsg) {
         if (getComputedStyle(errorMsg).display === 'none') {
             errorMsg.style.display = 'block';
             if(loader) loader.style.display = 'none';
             errorText.textContent = "CRITICAL TIMEOUT (>60s).\nAngular failed to bootstrap.\n\nPossible causes:\n1. Network blocked (CDN unreachable)\n2. JavaScript execution stalled\n3. Missing dependencies";
         }
      }
    }, 60000);
  </script>

  <!-- Load Main Script -->
  <script type="module" src="./src/main.ts"></script>
</body>
</html>
